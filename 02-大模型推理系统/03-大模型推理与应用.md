# 大模型推理与应用

## 常见大模型文件格式

1. 纯二进制文件（如.pb/.pt/.ckpt等）
2. safetensors格式
3. gguf格式

## 文本生成（Causal LM）

对于每个输入token，模型输出下一个token的概率分布

## 采样

### Argmax

选取概率最大的词，结果单一，常用于精度测试

### 随机采样

按照概率分布随机选取词，结果多样性高

- top-k：从概率最高的k个词里采样
- top-p：从概率累加达到p的词里采样
- temperature：调整概率分布的平滑度，越大采样结果越随机

参数加载时要注意矩阵转置。

### Beam Search

多次采样，保留概率最高的k个候选结果，然后继续采样，直到达到最大长度或遇到结束符。

- 可以考虑更多未来的token，效果更好但会占用资源

## KV Cache

在多轮推理中，通过缓存前面轮次的KV结果，减少重复计算。

- KV Cache即是大模型的“记忆”

- 有长度限制

## AI对话

通过在文本生成任务中增加角色信息，实现AI对话。

- Template：模型的对话模板，根据角色对输入增加相应token。

- 对话回滚：通过回溯KV Cache，实现对话的重新推理。
